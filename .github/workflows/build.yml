name: Build Eden wrapper (arm64)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install required packages
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build unzip

    - name: Download Android NDK r25c
      run: |
        mkdir -p $HOME/android-ndk
        cd $HOME/android-ndk
        curl -L https://dl.google.com/android/repository/android-ndk-r25c-linux.zip -o ndk.zip
        unzip -q ndk.zip
        echo "NDK_HOME=$HOME/android-ndk/android-ndk-r25c" >> $GITHUB_ENV

    - name: Configure with CMake
      run: |
        mkdir -p build
        cd build
        cmake -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=$NDK_HOME/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release \
          ..

    - name: Build
      run: |
        cd build
        ninja

    - name: Package ZIP
      run: |
        cd build
        PKG="your_wrapper"
        rm -f ${PKG}.zip
        
        # find built libvulkan.so
        LIBFILE=$(find . -name "libvulkan.so" | head -n 1)
        echo "Found: $LIBFILE"
        cp "$LIBFILE" ../libvulkan.so

        cd ..
        rm -rf eden_pkg
        mkdir eden_pkg

        cp manifest.json eden_pkg/
        cp libvulkan.so eden_pkg/
        cp -r config eden_pkg/

        cd eden_pkg
        zip -r ../${PKG}.zip .

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: your_wrapper
        path: your_wrapper.zip
